ALTER TABLE groups MODIFY COLUMN id INT AUTO_INCREMENT;

SHOW VARIABLES LIKE 'event_scheduler';

SET GLOBAL event_scheduler = ON;

CREATE EVENT update_test_code_to_null
ON SCHEDULE EVERY 1 MINUTE
DO
  UPDATE activated_test at
  JOIN test t ON at.test_id = t.id_test
  SET at.test_code = NULL
  WHERE at.test_code IS NOT NULL
    AND at.activation_time <= NOW() - INTERVAL t.time MINUTE;


DELIMITER //

CREATE TRIGGER after_insert_link_account_activated_test_answer
AFTER INSERT ON link_account_activated_test_answer
FOR EACH ROW
BEGIN
  UPDATE link_account_activated_test laatt
  JOIN answers a ON NEW.answer_id = a.answer_id
  JOIN questions q ON a.question_id = q.id_question
  SET laatt.points = q.points + a.points
  WHERE laatt.id = NEW.link_account_activated_test_id;
END; //

DELIMITER ;

DELIMITER //

CREATE TRIGGER after_update_answers_points
AFTER UPDATE ON answers
FOR EACH ROW
BEGIN
  IF OLD.points <> NEW.points THEN
    UPDATE link_account_activated_test laatt
    JOIN link_account_activated_test_answer laata ON laatt.id = laata.link_account_activated_test_id
    JOIN questions q ON NEW.question_id = q.id_question
    SET laatt.points = q.points + NEW.points
    WHERE laata.answer_id = NEW.answer_id;
  END IF;
END; //

DELIMITER ;
